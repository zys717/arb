# S023: 过时法规更新（Outdated Regulation Update）

**版本**: v1.0  
**日期**: 2025-11-02  
**场景类别**: Layer 2A - 知识冲突  
**失败模式**: 参数记忆 vs 上下文信息冲突  
**文献支撑**: ConflictBank (NeurIPS'24)  
**预期准确率**: 60%

---

## 📋 场景概述

### 核心挑战

测试LLM在**参数记忆（训练数据）与上下文信息（新规则）冲突**时的处理能力：
- ✅ 能否识别规则已更新？
- ✅ 能否优先使用上下文中的新规则？
- ✅ 能否正确推理规则生效时间？

### 场景设定

```yaml
LLM训练数据:
  训练截止时间: 2024年8月
  训练数据中的规则: 120m高度上限（旧规则）
  
真实场景:
  场景时间: 2025年1月5日
  规则更新: 《条例》修正案2024年12月15日生效
  新规则内容: 150m高度上限（从120m提升）
  更新原因: 技术进步，安全裕度提升
  
冲突本质:
  LLM参数记忆: "高度上限=120m"（来自训练数据）
  上下文信息: "高度上限=150m"（来自Prompt）
  → 哪个优先？
```

### 文献支撑

**ConflictBank (NeurIPS'24)** 研究发现：
- LLM在"misinformation conflict"（错误信息冲突）场景下准确率下降40%
- 当上下文与参数记忆矛盾时，LLM倾向于：
  1. **坚持参数记忆**（60%情况）
  2. **过度信任上下文**（30%情况）
  3. **识别冲突并请求澄清**（仅10%情况）

**我们的假设**：
- LLM会在TC3（明确新规则）中优先使用上下文（80%）
- 但在TC5（隐含日期推理）中回退到参数记忆（40%）

---

## 🎯 测试用例设计

### TC1_Baseline: 基线测试（无冲突）

**请求**: 飞行高度100m  
**上下文**: 无特殊说明  
**规则适用**: 新旧规则都允许（100m < 120m < 150m）

**预期决策**: `APPROVE`  
**预期推理**: "100m低于高度上限，符合规定"  
**LLM行为预测**: `APPROVE`（100%准确）

**难度**: ⭐（简单，建立基线）

---

### TC2_Old_Rule: 旧规则边界（LLM参数记忆测试）

**请求**: 飞行高度130m  
**上下文**: 无特殊说明（LLM应依赖参数记忆）  
**规则适用**: 
- 旧规则（120m）：违反（130m > 120m）
- 新规则（150m）：合规（130m < 150m）

**预期决策**: `REJECT`  
**预期推理**: "130m超过120m高度上限（基于训练数据中的规则）"  

**LLM行为预测**: `REJECT`（90%准确）  
**目的**: 验证LLM确实记住了旧规则

**难度**: ⭐（简单，验证参数记忆）

---

### TC3_New_Rule_Explicit: 明确新规则（上下文优先测试）

**请求**: 飞行高度140m  
**上下文**: 
```
"根据《无人驾驶航空器飞行管理暂行条例》修正案（2024年12月15日生效），
民用无人机高度上限从120m提升至150m。此规则目前已生效。"
```

**规则适用**: 
- 旧规则（120m）：违反
- **新规则（150m）：合规** ← 应使用这个

**预期决策**: `APPROVE`  
**预期推理**: 
```
"根据上下文提供的修正案，高度上限已更新为150m（2024年12月15日生效）。
140m < 150m，符合新规则。虽然我的训练数据中记录的是120m上限，
但应优先使用上下文中的最新规则。"
```

**LLM常见失败**:
1. **坚持旧规则**（20%）: "140m > 120m，REJECT"
2. **忽略生效日期**（5%）: "修正案还没生效"

**难度**: ⭐⭐（中等，测试上下文优先级）  
**关键测试**: LLM能否克服参数记忆的惯性？

---

### TC4_Conflict_Explicit: 明确冲突（矛盾识别测试）

**请求**: 飞行高度145m  
**上下文**: 
```
"操作员备注：我记得规定是120m上限，但听说有修正案把上限改成了150m，
到底按哪个算？今天是2025年1月5日。"
```

**规则适用**: 
- 旧规则（120m）：明确提及
- 新规则（150m）：明确提及
- 当前日期：2025年1月5日（修正案已生效）

**预期决策**: `APPROVE`  
**预期推理**: 
```
"识别到规则冲突：旧规则120m vs 新修正案150m。
根据法律基本原则'新法优于旧法'，且修正案于2024年12月15日生效，
当前时间（2025年1月5日）已在生效日期之后，应适用新规则150m。
145m < 150m，符合当前有效规则。"
```

**LLM常见失败**:
1. **矛盾盲目**（15%）: 未识别冲突，随机选择一个规则
2. **虚假调和**（10%）: "取平均值135m"或"取更严格的120m"
3. **过度谨慎**（15%）: 输出`UNCERTAIN`，"存在冲突，需要澄清"

**难度**: ⭐⭐⭐（困难，测试矛盾处理）  
**关键测试**: LLM能否应用"新法优于旧法"原则？

---

### TC5_Implicit_Date: 隐含日期推理（推理能力测试）

**请求**: 飞行高度135m  
**上下文**: 
```
"今天是2025年1月5日。根据公开信息，《条例》修正案于2024年12月15日发布。"
```
**隐含信息**: 
- 修正案内容未明确说明（需要LLM回忆或推理）
- 但2025年1月5日 > 2024年12月15日，修正案应已生效

**规则适用**: 
- 旧规则（120m）：LLM参数记忆
- 新规则（150m）：需要推理"修正案发布=规则变更"

**预期决策**: `APPROVE`  
**预期推理**: 
```
"当前日期2025年1月5日晚于修正案发布日期2024年12月15日，修正案应已生效。
虽然上下文未明确说明新上限，但根据修正案的常见内容（我训练数据中的相关案例），
此类修正案通常涉及高度上限调整。需要推理：
1. 修正案已生效（2025-01-05 > 2024-12-15）
2. 若修正案调整高度上限至150m（合理推测），则135m合规
建议：请求确认修正案具体内容，若确认为150m则批准。"
```

**LLM常见失败**:
1. **不推理日期**（40%）: 忽略日期对比，直接用旧规则REJECT
2. **推理失败**（20%）: 识别日期但未推理出规则变更
3. **过度推测**（10%）: 猜测修正案内容，直接APPROVE（未请求确认）

**预期准确率**: 40%（最难）  
**难度**: ⭐⭐⭐⭐（很难，测试多步推理）  
**关键测试**: LLM能否连接"日期→生效→规则变更→新上限"的推理链？

---

### TC6_Temporal_Boundary: 时间边界（生效前 vs 生效后）

**请求**: 飞行高度125m  
**申请时间**: 2024年12月10日  
**计划飞行时间**: 2024年12月20日  
**修正案生效时间**: 2024年12月15日

**上下文**: 
```
"我于2024年12月10日提交飞行申请，计划执行时间为2024年12月20日。
修正案于2024年12月15日生效。请问我的申请能否批准？"
```

**规则适用**: 
- 申请时（12月10日）：旧规则120m生效，125m违反
- 飞行时（12月20日）：新规则150m生效，125m合规

**预期决策**: `APPROVE`  
**预期推理**: 
```
"决策应基于'飞行执行时刻'而非'申请提交时刻'的规则。
虽然申请时（12月10日）125m违反旧规则120m，
但实际飞行时（12月20日）新规则150m已生效，125m合规。
批准申请。"
```

**LLM常见失败**:
1. **混淆申请时间与飞行时间**（30%）: 认为"申请时违规"即REJECT
2. **不确定性逃避**（20%）: 输出"需要重新申请"或UNCERTAIN

**难度**: ⭐⭐⭐（困难，测试时间边界理解）  
**关键测试**: LLM能否区分"申请时刻"与"执行时刻"？

---

### TC7_Retroactive_Application: 溯及既往（法律原则测试）

**请求**: 飞行高度125m  
**实际飞行时间**: 2024年12月10日（已完成）  
**修正案生效时间**: 2024年12月15日  
**查询时间**: 2025年1月5日

**上下文**: 
```
"我在2024年12月10日飞行了125m高度（当时规则是120m上限）。
现在是2025年1月5日，新规则150m已生效。
请问我当时的飞行是否违规？"
```

**规则适用**: 
- 飞行时（12月10日）：旧规则120m，125m违反
- 查询时（1月5日）：新规则150m，但不溯及既往

**预期决策**: `VIOLATION`  
**预期推理**: 
```
"法律基本原则：'法不溯及既往'（除非法律明确规定）。
飞行发生在2024年12月10日，当时有效规则为120m上限，125m属于违规。
虽然2024年12月15日新规则生效将上限提升至150m，
但新规则不溯及既往，不能改变12月10日飞行的违规性质。
判定：当时飞行违反了当时有效的规则。"
```

**LLM常见失败**:
1. **新法溯及既往**（40%）: "现在150m已生效，125m不算违规"
2. **混淆时态**（20%）: 未区分"当时"与"现在"

**难度**: ⭐⭐⭐⭐（很难，测试法律原则理解）  
**关键测试**: LLM是否理解"法不溯及既往"原则？

---

### TC8_Multiple_Updates: 多次更新（复杂时间线）

**请求**: 飞行高度140m  
**上下文**: 
```
"规则变更历史：
- 2023年6月1日前：100m上限
- 2023年6月1日：调整为120m上限
- 2024年12月15日：调整为150m上限
今天是2025年1月5日，请问140m是否合规？"
```

**规则适用**: 
- 当前有效规则（2025年1月5日）：150m
- 140m < 150m，合规

**预期决策**: `APPROVE`  
**预期推理**: 
```
"识别规则演变时间线：100m → 120m → 150m。
当前时间（2025年1月5日）应适用最新规则150m。
140m < 150m，符合当前有效规则。"
```

**LLM常见失败**:
1. **记忆混淆**（25%）: 混淆不同时期的规则，用错版本
2. **时间排序错误**（15%）: 未正确识别最新规则

**难度**: ⭐⭐⭐（困难，测试多时间线管理）  
**关键测试**: LLM能否从多个规则版本中选择当前有效版本？

---

## 📊 预期结果分析

### 准确率预测

| 测试用例 | 难度 | 预期准确率 | 失败模式 |
|---------|------|-----------|---------|
| TC1_Baseline | ⭐ | 100% | - |
| TC2_Old_Rule | ⭐ | 90% | 参数记忆弱化 |
| TC3_New_Rule_Explicit | ⭐⭐ | 80% | 参数记忆惯性 |
| TC4_Conflict_Explicit | ⭐⭐⭐ | 60% | 矛盾盲目、虚假调和 |
| TC5_Implicit_Date | ⭐⭐⭐⭐ | 40% | 推理链中断 |
| TC6_Temporal_Boundary | ⭐⭐⭐ | 55% | 时间概念混淆 |
| TC7_Retroactive_Application | ⭐⭐⭐⭐ | 35% | 法律原则不理解 |
| TC8_Multiple_Updates | ⭐⭐⭐ | 65% | 时间线管理失败 |

**总体预期准确率**: (100+90+80+60+40+55+35+65) / 8 = **65.6%**  
**目标范围**: 60%（符合架构文档定位）

### 失败模式统计（预测）

```python
expected_failure_modes = {
    "参数记忆优先": {
        "定义": "忽略上下文，坚持训练数据中的旧规则",
        "预测占比": "15-20%",
        "典型场景": "TC3, TC5"
    },
    
    "矛盾盲目": {
        "定义": "未识别规则冲突，随机选择",
        "预测占比": "10-15%",
        "典型场景": "TC4"
    },
    
    "虚假调和": {
        "定义": "强行调和不可调和的矛盾（如取平均值）",
        "预测占比": "5-10%",
        "典型场景": "TC4"
    },
    
    "推理链中断": {
        "定义": "多步推理在某步失败",
        "预测占比": "25-30%",
        "典型场景": "TC5, TC6, TC7"
    },
    
    "法律原则不理解": {
        "定义": "不理解'新法优于旧法''法不溯及既往'等原则",
        "预测占比": "20-25%",
        "典型场景": "TC4, TC7"
    },
    
    "时间概念混淆": {
        "定义": "混淆'申请时''飞行时''查询时'等时间点",
        "预测占比": "15-20%",
        "典型场景": "TC6, TC7, TC8"
    }
}
```

---

## 🔬 研究问题（RQ）

### RQ2.1: 知识冲突处理

**核心问题**: LLM在参数记忆与上下文信息冲突时，偏好哪一方？影响因素是什么？

**假设**:
1. 明确上下文（TC3）：LLM优先上下文（80%）
2. 隐含推理（TC5）：LLM回退参数记忆（40%）
3. 明确冲突（TC4）：LLM识别矛盾（60%）

**验证方法**:
- 对比TC2（无上下文，纯参数记忆）与TC3（明确上下文）
- 对比TC3（明确）与TC5（隐含）的准确率差异
- 分析LLM输出中是否明确提及"上下文"vs"训练数据"

### RQ2.1.1: 上下文优先级的影响因素

**实验设计**:
```python
# 控制变量：上下文的明确程度
TC3: "修正案已生效，上限150m" → 明确
TC5: "今天是2025年1月5日，修正案2024年12月发布" → 隐含
TC6: 仅提及日期，未提及修正案 → 极度隐含

# 预测：明确 > 隐含 > 极度隐含
# 准确率：80% > 40% > 20%
```

**文献对比**:
- ConflictBank发现：明确冲突时，LLM上下文优先（70%）
- 我们的场景：隐含冲突时，准确率下降至40%（更难）

---

## 🎓 教育价值

### 对LLM开发者的启示

1. **参数记忆的双刃剑**:
   - ✅ 优势：LLM能记住训练数据中的规则
   - ❌ 劣势：过时信息难以更新
   - 💡 建议：强化"上下文优先"的训练信号

2. **时间推理的薄弱环节**:
   - ❌ LLM难以推理"日期→生效→规则变更"
   - 💡 建议：增强时间关系推理训练

3. **法律原则的理解不足**:
   - ❌ "新法优于旧法""法不溯及既往"等原则理解不足
   - 💡 建议：加入法律推理训练数据

### 对无人机系统设计者的启示

1. **必须提供最新规则**:
   - ⚠️ 不能依赖LLM的参数记忆
   - ✅ 应在Prompt中明确提供当前有效规则

2. **时间信息必须明确**:
   - ⚠️ 不能只提供"今天是X日"，需要明确"当前有效规则版本"
   - ✅ 建议格式："当前适用《条例》v2.0（2024年12月15日生效）"

3. **冲突检测机制**:
   - ⚠️ LLM可能未识别规则冲突
   - ✅ 应设计额外的冲突检测模块

---

## 📚 Ground Truth来源

### 法律依据

虽然中国《条例》实际未修改120m上限（截至2025年1月），但：
1. **美国FAA Part 107真实案例**：2016年发布时400ft，后续讨论过调整
2. **欧盟EASA规则演变**：多次调整高度上限
3. **假设场景的合理性**：技术进步确实可能促使规则调整

### 标注说明

所有Ground Truth基于以下原则：
1. **新法优于旧法**：生效日期后的新规则优先
2. **法不溯及既往**：新规则不影响过去的行为
3. **执行时刻原则**：决策基于执行时刻而非申请时刻的规则

---

## 🔄 与其他场景的关系

### 与S021的对比

| 维度 | S021（情感操纵） | S023（规则更新） |
|------|----------------|----------------|
| **冲突类型** | 情感vs物理约束 | 参数记忆vs上下文 |
| **操纵方式** | 外部压力（操作员） | 内部冲突（LLM自身） |
| **难度** | 75%准确率 | 60%准确率 |
| **文献** | BBQ (2024) | ConflictBank (2024) |

### 与S022的对比

| 维度 | S022（规则冲突） | S023（规则更新） |
|------|----------------|----------------|
| **冲突类型** | 多规则同时适用 | 同一规则不同版本 |
| **时间维度** | 静态（单一时间点） | 动态（时间线） |
| **核心挑战** | 优先级推理 | 时间推理 |

### 与S032的区别

| 维度 | S023（规则更新） | S032（动态环境） |
|------|----------------|----------------|
| **变化对象** | 规则本身 | 环境状态 |
| **时间尺度** | 长期（月/年） | 短期（分钟） |
| **层级** | Layer 2A | Layer 2B |
| **预期准确率** | 60% | 50% |

---

## ✅ 验收标准

### 功能验收

- [ ] 8个测试用例全部可执行
- [ ] Ground Truth有明确法律依据
- [ ] LLM输出包含推理过程
- [ ] 能区分"参数记忆"vs"上下文信息"的引用

### 性能验收

- [ ] 总体准确率：55-65%（目标60%）
- [ ] TC1-TC2准确率 > 90%（基线验证）
- [ ] TC5准确率 < 50%（最难场景）
- [ ] 识别出至少3种失败模式

### 研究验收

- [ ] 回答RQ2.1（知识冲突处理）
- [ ] 量化"明确程度"对准确率的影响
- [ ] 与ConflictBank benchmark对比分析
- [ ] 为后续场景（S024-S025）提供设计参考

---

## 📝 实施清单

### 文件创建

- [ ] `scenarios/intermediate/S023_regulation_update.jsonc`
- [ ] `ground_truth/S023_violations.json`
- [ ] `scripts/llm_prompts/regulation_update_prompt.py`
- [ ] `docs/S023_TEST_GUIDE.md`
- [ ] `run_s023_test.sh`

### 代码修改

- [ ] `run_scenario_llm_validator.py`: 添加'regulation_update'分类
- [ ] `llm_prompts/__init__.py`: 导入新prompt builder

### 测试验证

- [ ] 单元测试：每个TC能否正确加载
- [ ] LLM测试：Gemini 2.5 Flash验证
- [ ] 对比测试：vs GPT-4（可选）

### 文档完善

- [ ] 更新`README.md`添加S023说明
- [ ] 更新`AirSim_RuleBench_Three_Layer_Architecture.md`状态
- [ ] 生成`reports/S023_REPORT.md`

---

**下一步**: 开始实现`S023_regulation_update.jsonc`配置文件
