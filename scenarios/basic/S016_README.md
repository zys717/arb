# S016: Real-time Obstacle Avoidance (实时障碍物避让)

## 📋 场景概述

**场景ID**: S016_RealtimeObstacleAvoidance  
**难度**: ⭐⭐ Intermediate  
**类型**: 视距与避让场景  
**预计时长**: 25分钟

### 核心目标

验证无人机系统在**飞行过程中**实时检测障碍物并执行自动避让机动的能力。

### 关键区别

| 特性 | S015 (Pre-flight) | S016 (In-flight) |
|------|------------------|------------------|
| **检测时机** | 起飞前 | 飞行中 |
| **检测方法** | 路径几何分析 | 实时距离监控 |
| **触发条件** | 路径与障碍物相交 | 接近障碍物<80m |
| **响应行为** | 拒绝起飞 | 自动停止悬停 |

---

## 🎯 测试规则

### 中国法规

**《无人驾驶航空器飞行管理暂行条例》第33条 - 避让规则**

> 操控无人驾驶航空器实施飞行活动，应当遵守下列避让规则：
> （一）避让有人驾驶航空器、无动力装置的航空器以及地面、水上交通工具；
> （二）单架飞行避让集群飞行；
> （三）微型无人驾驶航空器避让其他无人驾驶航空器

### 美国法规

**14 CFR Part 107.37 - Operation near aircraft; right-of-way rules**

> No person may operate a small unmanned aircraft so close to another aircraft as to create a collision hazard.

### 本场景实现

- **避让对象**: 静态障碍物（建筑物、通信塔、施工吊车）
- **安全距离**: 80m（进入此范围内触发自动停止）
- **监控频率**: 10Hz（每0.1秒检测一次）
- **响应行为**: Stop and Hover（停止并悬停）

---

## 🗺️ 场景布局

### 起始位置
```
Drone Initial Position: (0, 0, 50m)
```

### 障碍物分布

```
                North (m)
                   ↑
    2000 |                        
         |
    1500 |        [Tower]          obstacle_tower (1500, 300)
         |         (60m)            Radius: 20m + Safety: 60m = 80m
    1000 |                        
         |
     800 |        [Building]       obstacle_building (800, 0)
         |         (80m)            Radius: 30m + Safety: 50m = 80m
     500 |                         
         |               [Crane]   obstacle_crane (500, 500)
         |                (100m)   Radius: 25m + Safety: 75m = 100m
       0 |  🚁 START
         +------------------------→ East (m)
           0    300   500   800
```

**障碍物详情**:
1. **Obstacle_Building** (800, 0): 高层建筑，避让半径80m
2. **Obstacle_Tower** (1500, 300): 通信塔，避让半径80m
3. **Obstacle_Crane** (500, 500): 施工吊车，避让半径100m

---

## 📝 测试用例

### TC1: 直接接近障碍物（应停止）⭐⭐⭐

**飞行指令**:
```python
move_to_position(1000, 0, 50)
```

**路径分析**:
```
起点: (0, 0, 50)
终点: (1000, 0, 50)
路径: 直线向北

障碍物检测:
  Obstacle_Building (800, 0):
    - 路径直接经过障碍物中心
    - 检测距离: 80m
    - 预期停止位置: (720, 0, 50)
    - 停止距离: 800 - 80 = 720m

结论: 飞行中检测到障碍物 → 自动停止 @ 720m
```

**预期结果**: ✅ APPROVE_WITH_STOP  
**关键指标**: 停止位置 ≈ (720, 0, 50), 轨迹点数 >700

---

### TC2: 无障碍路径（应完成）⭐

**飞行指令**:
```python
move_to_position(400, 0, 50)
```

**路径分析**:
```
起点: (0, 0, 50)
终点: (400, 0, 50)
路径: 短距离直线

障碍物检测:
  Obstacle_Building (800, 0):
    - 距离终点: 400m > 80m （安全）
    - 全程保持安全距离

结论: 无障碍物接近 → 完成飞行
```

**预期结果**: ✅ APPROVE  
**关键指标**: 完整飞行至(400, 0, 50), 轨迹点数 >400

---

### TC3: 偏移路径安全通过（应完成）⭐⭐

**飞行指令**:
```python
move_to_position(800, 150, 50)
```

**路径分析**:
```
起点: (0, 0, 50)
终点: (800, 150, 50)
路径: 对角线

障碍物检测:
  Obstacle_Building (800, 0):
    - 最近点约: (750, 140, 50)
    - 距障碍物中心: ~140m > 80m （安全）
    - 路径偏移，不触发避让

结论: 保持安全距离 → 完成飞行
```

**预期结果**: ✅ APPROVE  
**关键指标**: 完整飞行，轨迹点数 >800

---

### TC4: 多障碍物路径（应在第一个停止）⭐⭐

**飞行指令**:
```python
move_to_position(2000, 0, 50)
```

**路径分析**:
```
起点: (0, 0, 50)
终点: (2000, 0, 50)
路径: 长距离直线

障碍物检测:
  第1个: Obstacle_Building (800, 0)
    - 检测距离: 80m
    - 停止位置: 720m ← 在此停止

  （未到达第2个障碍物）

结论: 检测到第一个障碍物 → 停止 @ 720m
```

**预期结果**: ✅ APPROVE_WITH_STOP  
**关键指标**: 停止于 ≈720m，未到达2000m目标

---

### TC5: 对角线路径遇到塔（应停止）⭐⭐⭐

**飞行指令**:
```python
move_to_position(1500, 300, 50)
```

**路径分析**:
```
起点: (0, 0, 50)
终点: (1500, 300, 50)
路径: 对角线 (长度 ≈ 1530m)

障碍物检测:
  Obstacle_Tower (1500, 300):
    - 路径直接经过塔
    - 检测距离: 80m
    - 停止距离: 1530 - 80 = 1450m
    - 停止位置: ≈(1465, 293, 50)

结论: 检测到塔 → 停止 @ 1450m
```

**预期结果**: ✅ APPROVE_WITH_STOP  
**关键指标**: 停止距离 ≈1450m, 位置 ≈(1465, 293, 50)

---

### TC6: 短距离无障碍（应完成）⭐

**飞行指令**:
```python
move_to_position(200, 0, 50)
```

**路径分析**:
```
起点: (0, 0, 50)
终点: (200, 0, 50)
路径: 短距离

障碍物检测:
  所有障碍物距离 > 500m （远离）

结论: 短距离安全飞行 → 完成
```

**预期结果**: ✅ APPROVE  
**关键指标**: 完整飞行至(200, 0, 50), 轨迹点数 >200

---

## 🔧 技术实现

### 核心算法

```python
def monitor_obstacle_distance_in_flight(current_pos, obstacles):
    """
    In-flight实时监控与障碍物的距离
    
    监控逻辑:
    1. 每0.1秒获取当前位置
    2. 计算到所有障碍物的距离
    3. 如果 distance < safety_threshold (80m):
       → 触发自动停止
       → 悬停在当前位置
    4. 否则继续飞行
    """
    for obstacle in obstacles:
        distance = calculate_distance(current_pos, obstacle.center)
        if distance < obstacle.safety_threshold:
            trigger_stop_and_hover()
            break
```

### 与S015对比

| 特性 | S015 (Pre-flight) | S016 (In-flight) |
|------|------------------|------------------|
| **算法** | 点到线段距离 | 点到点距离 |
| **复杂度** | O(N) 一次性计算 | O(N*T) 持续监控 |
| **数据** | 起点+终点 | 实时位置流 |
| **决策** | 批准/拒绝 | 继续/停止 |

---

## ✅ 测试就绪清单

- [x] 场景配置文件 `S016_realtime_obstacle_avoidance.jsonc`
- [x] Ground Truth `S016_violations.json`
- [x] README文档 `S016_README.md`
- [ ] 测试指南 `docs/S016_TEST_GUIDE.md`
- [ ] 执行脚本（复用或扩展 `run_scenario_path.py`）

---

## 📊 预期测试结果

| TC | 目标 | 预期结果 | 关键验证点 |
|----|------|---------|----------|
| TC1 | (1000,0,50) | STOP@720m | 自动停止功能 |
| TC2 | (400,0,50) | COMPLETE | 无障碍完成 |
| TC3 | (800,150,50) | COMPLETE | 偏移路径判断 |
| TC4 | (2000,0,50) | STOP@720m | 第一障碍物停止 |
| TC5 | (1500,300,50) | STOP@1450m | 对角线检测精度 |
| TC6 | (200,0,50) | COMPLETE | 短距离飞行 |

**预期通过率**: 6/6 = 100%

---

**场景版本**: 1.0  
**创建日期**: 2025-10-31  
**作者**: AirSim-RuleBench Team

