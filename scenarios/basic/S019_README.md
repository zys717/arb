# S019: 适飞空域分类与审批判断

## 📋 场景概述

**场景ID**: S019_AirspaceClassification  
**难度等级**: ⭐⭐  
**场景类型**: 空域分类规则验证  
**版本**: 1.0  
**创建日期**: 2025-11-01

### 核心测试目标

验证无人机系统对**空域分类规则**的合规性检查能力，包括：
1. **120米高度边界**：适飞空域（<120m）vs 管制空域（≥120m）
2. **限制区域检测**：军事敏感区域全高度需审批
3. **审批要求判断**：根据空域类型和审批状态做出决策
4. **多目标验证**：一次飞行多个航点，全部通过才批准
5. **优先级规则**：限制区域 > 高度边界 > 审批状态

---

## 🎯 规则定义

### R019: 空域分类与审批规则

| 空域类型 | 高度范围 | 区域范围 | 审批要求 | 说明 |
|---------|---------|---------|---------|------|
| **适飞空域** | 0-119m | 全地图（除限制区） | ❌ 不需要 | 轻型及以下无人机免审批 |
| **管制空域** | ≥120m | 全地图 | ✅ 需要 | 需提前申请飞行审批 |
| **限制区域** | 全高度 | 圆形区域(1500,0,300m半径) | ✅ 需要 | 军事敏感区，无论高度 |

### 法规依据

1. **中国《条例》第19条** - 适飞空域定义
   > "适飞空域为真高120米以下的空域"

2. **中国《条例》第31条第一款** - 免审批条件
   > "微型、轻型、小型无人驾驶航空器在适飞空域内的飞行活动...无需提出飞行活动申请"

3. **美国Class G空域规则** - 未管制空域
   > 通常在地面以上1200英尺（约365米）以下为Class G未管制空域

### 决策逻辑

```python
# 优先级从高到低
1. 检查是否在限制区域内
   └─ 是 → 需要审批
   └─ 否 → 继续下一步

2. 检查目标高度是否 ≥ 120m
   └─ 是 → 进入管制空域，需要审批
   └─ 否 → 适飞空域，继续下一步

3. 检查审批状态
   └─ 有审批 → APPROVE
   └─ 无审批但在适飞空域 → APPROVE（轻型机豁免）
   └─ 无审批但需要审批 → REJECT
```

---

## 🧪 测试用例

### TC1: 适飞空域飞行 ✅

**测试目标**: 验证适飞空域内的免审批飞行

| 目标点 | 坐标 | 高度 | 空域类型 |
|-------|------|------|---------|
| Target 1 | (500, 0) | 50m | 适飞空域 |
| Target 2 | (800, 200) | 119m | 适飞空域（边界内） |

**审批状态**: ❌ 无审批  
**预期结果**: ✅ **APPROVE**  
**预期原因**: 所有目标高度均在适飞空域内（<120m），轻型无人机无需审批

**验证点**:
- ✅ 50m < 120m → 适飞空域
- ✅ 119m < 120m → 适飞空域（边界测试）
- ✅ 非限制区域
- ✅ 轻型无人机免审批

---

### TC2: 管制空域未审批 🚫

**测试目标**: 验证管制空域的审批要求

| 目标点 | 坐标 | 高度 | 空域类型 |
|-------|------|------|---------|
| Target 1 | (500, 0) | 120m | 管制空域（边界） |
| Target 2 | (800, 200) | 150m | 管制空域 |

**审批状态**: ❌ 无审批  
**预期结果**: 🚫 **REJECT**  
**预期原因**: 目标高度进入管制空域（≥120m），需要飞行审批

**验证点**:
- ❌ 120m ≥ 120m → 管制空域（边界测试）
- ❌ 150m > 120m → 管制空域
- ❌ 未获审批 → 拒绝

---

### TC3: 管制空域已审批 ✅

**测试目标**: 验证审批后的管制空域飞行

| 目标点 | 坐标 | 高度 | 空域类型 |
|-------|------|------|---------|
| Target 1 | (500, 0) | 150m | 管制空域 |
| Target 2 | (1000, 500) | 200m | 管制空域 |

**审批状态**: ✅ 有审批  
**预期结果**: ✅ **APPROVE**  
**预期原因**: 已获得管制空域飞行审批，可在120m以上飞行

**验证点**:
- ✅ 150m, 200m > 120m → 管制空域
- ✅ has_approval = true → 通过
- ✅ 非限制区域

---

### TC4: 限制区域未审批 🚫

**测试目标**: 验证限制区域的全高度管制

| 目标点 | 坐标 | 高度 | 区域类型 | 距中心 |
|-------|------|------|---------|--------|
| Target 1 | (1500, 0) | 50m | 限制区域 | 0m |
| Target 2 | (1600, 100) | 100m | 限制区域 | 141m |

**限制区域**: 中心(1500,0)，半径300m  
**审批状态**: ❌ 无审批  
**预期结果**: 🚫 **REJECT**  
**预期原因**: 目标位置在军事限制区内，无论高度均需审批

**验证点**:
- ✅ 目标1: 距离0m < 300m → 在限制区内
- ✅ 目标2: 距离141m < 300m → 在限制区内
- ⚠️  虽然高度<120m，但限制区域优先级更高
- ❌ 未获审批 → 拒绝

---

### TC5: 限制区域已审批 ✅

**测试目标**: 验证审批后的限制区域飞行

| 目标点 | 坐标 | 高度 | 区域类型 |
|-------|------|------|---------|
| Target 1 | (1500, 0) | 50m | 限制区域+适飞空域 |
| Target 2 | (1500, 0) | 150m | 限制区域+管制空域 |

**限制区域**: 中心(1500,0)，半径300m  
**审批状态**: ✅ 有审批  
**预期结果**: ✅ **APPROVE**  
**预期原因**: 已获得限制区域飞行审批，可在限制区内任意高度飞行

**验证点**:
- ✅ 位置在限制区内
- ✅ 高度包括<120m和>120m
- ✅ has_approval = true → 通过
- ✅ 限制区域审批包含所有高度

---

## 📊 测试覆盖矩阵

| 规则维度 | 测试用例 | 通过 | 拒绝 | 覆盖率 |
|---------|---------|------|------|-------|
| **适飞空域** | TC1 | 1 | 0 | 100% |
| **管制空域** | TC2, TC3 | 1 | 1 | 100% |
| **限制区域** | TC4, TC5 | 1 | 1 | 100% |
| **边界值测试** | TC1(119m), TC2(120m) | 1 | 1 | 100% |
| **审批逻辑** | TC3, TC5 | 2 | 0 | 100% |
| **多目标验证** | 全部TC | 3 | 2 | 100% |

**总计**: 5个测试用例，预期3个APPROVE，2个REJECT

---

## 🔧 技术实现要点

### 1. 高度边界检测

```python
def check_altitude_boundary(altitude: float, ceiling: float = 120.0) -> str:
    """
    检查高度边界
    边界判断使用 >= (exclusive boundary)
    """
    if altitude >= ceiling:
        return "controlled"  # 管制空域
    else:
        return "uncontrolled"  # 适飞空域
```

**关键点**:
- 使用 `>=` 判断，120m及以上属于管制空域
- TC1的119m测试验证边界内
- TC2的120m测试验证边界上

### 2. 限制区域检测

```python
def check_restricted_area(
    position: Dict[str, float],
    center: Dict[str, float],
    radius: float
) -> bool:
    """检查是否在限制区域内"""
    distance = math.sqrt(
        (position['north'] - center['north'])**2 +
        (position['east'] - center['east'])**2
    )
    return distance <= radius
```

**关键点**:
- 使用2D水平距离（north, east）
- 不考虑高度差（限制区域覆盖全高度）
- TC4验证：0m和141m都在300m半径内

### 3. 分层决策逻辑

```python
def check_flight_approval(
    targets: List[Dict],
    restricted_area: Dict,
    altitude_ceiling: float,
    has_approval: bool
) -> Tuple[bool, str]:
    """
    分层决策逻辑
    优先级: 限制区域 > 高度边界 > 审批状态
    """
    for target in targets:
        # 优先级1: 检查限制区域
        if is_in_restricted_area(target, restricted_area):
            if not has_approval:
                return False, "限制区域内飞行需要审批"
            # 有审批则继续检查下一个目标
            continue
        
        # 优先级2: 检查高度边界
        if target['altitude'] >= altitude_ceiling:
            if not has_approval:
                return False, f"高度{target['altitude']}m进入管制空域，需要审批"
            # 有审批则继续检查下一个目标
            continue
        
        # 优先级3: 适飞空域且非限制区域
        # 轻型无人机免审批
        continue
    
    # 所有目标都通过检查
    return True, "所有目标符合飞行条件"
```

### 4. 多目标验证

```python
# 所有目标都需要通过检查
# 任何一个目标不合规，整个飞行计划拒绝
for target in targets:
    if not check_single_target(target):
        return "REJECT", reason
return "APPROVE"
```

**关键点**:
- TC1: 2个目标(50m, 119m)都在适飞空域
- TC2: 2个目标(120m, 150m)都在管制空域
- 任意一个不通过，全部拒绝

---

## 📈 预期结果分析

### 决策分布

```
✅ APPROVE: 3/5 (60%)
  - TC1: 适飞空域飞行
  - TC3: 管制空域已审批
  - TC5: 限制区域已审批

🚫 REJECT: 2/5 (40%)
  - TC2: 管制空域未审批
  - TC4: 限制区域未审批
```

### 关键边界值

| 边界 | 测试用例 | 阈值 | 测试值 | 结果 |
|-----|---------|------|-------|------|
| 高度上限 | TC1 | <120m | 119m | PASS |
| 高度边界 | TC2 | ≥120m | 120m | FAIL (需审批) |
| 距离边界 | TC4 | ≤300m | 0m, 141m | FAIL (限制区) |

### 优先级验证

| TC | 高度 | 区域 | 优先检查 | 结果 |
|----|------|------|---------|------|
| TC1 | 50m | 正常 | 高度✅ | PASS |
| TC2 | 120m | 正常 | 高度❌ | FAIL |
| TC4 | 50m | 限制 | 限制区❌ | FAIL (优先级高) |
| TC5 | 50m | 限制 | 限制区✅ | PASS (有审批) |

---

## 🎓 学习要点

### 1. 空域分类的层次性

```
限制区域（最高优先级）
    ├─ 需要特殊审批
    └─ 覆盖全高度范围
    
管制空域（第二优先级）
    ├─ ≥120m
    └─ 需要飞行审批
    
适飞空域（基础空域）
    ├─ <120m
    └─ 轻型机免审批
```

### 2. 边界值的重要性

- **119m**: 适飞空域最高点
- **120m**: 管制空域起点（使用 `>=` 判断）
- **边界判断**: 必须明确定义包含/排除关系

### 3. 多目标验证的严格性

- 飞行计划中的所有目标点都必须合规
- 类似"最短木板效应"，任一目标不合规则全部拒绝
- 这确保了整个飞行过程的安全性

### 4. 实际应用场景

- **快递配送**: 城市内通常在适飞空域（<120m），农村可能需要飞高
- **航拍任务**: 高空航拍（>120m）需要提前申请
- **军事禁区**: 绝对不能进入，即使是低空
- **应急救援**: 可能需要紧急审批进入限制区域

---

## 🚀 后续扩展方向

1. **动态限制区**: 临时限制区域（如重大活动期间）
2. **时间限制**: 某些空域在特定时段才需要审批
3. **机场空域**: 机场周边的特殊空域规则
4. **多层限制**: 不同高度层有不同的限制要求
5. **实时查询**: 集成空域管理系统API实时查询

---

**场景状态**: ✅ 设计完成，待实现  
**预计开发时间**: 4-6小时  
**难度评估**: ⭐⭐（空域判断逻辑）

