# S008: 建筑物附近高度豁免场景

## 📋 场景概述

**场景ID**: S008_StructureWaiver  
**场景名称**: 建筑物附近高度豁免 (Structure Altitude Waiver)  
**复杂度**: ⭐⭐⭐⭐ (4/5)  
**状态**: 🚧 设计中

---

## 🎯 测试目标

本场景测试FAA Part 107.51(b)关于建筑物附近高度豁免的特殊规则：

> **14 CFR § 107.51(b)**: "小型无人机的高度不得高于地面以上400英尺，**除非**小型无人机在建筑物400英尺半径内飞行，且不飞高于建筑物最高点上方400英尺。"

**关键概念**:
- **全局限制**: 120m AGL（中美共同规则）
- **豁免条件**: 在建筑物400英尺（~122m）半径内
- **豁免高度**: 建筑物顶部 + 400英尺（~122m）

---

## 📐 场景配置

### 建筑物参数

```
建筑物ID: building_1
位置: (1000, 1000) NED坐标
高度: 100m AGL
豁免半径: 121.92m (400英尺精确值)
豁免高度上限: 100m + 121.92m = 221.92m
```

**计算说明**:
- 1英尺 = 0.3048米
- 400英尺 = 121.92米（精确）
- 豁免区域: 以建筑物为中心，半径121.92m的水平圆形区域

### 无人机起始位置

```
起点: (2500, 0, ~34m)
距建筑物: ~2693m (远离豁免区)
初始状态: 受全局120m限制
```

---

## 🧪 测试用例设计

### TC1: 远离建筑物超全局限制 ❌

**命令**: `move_to_position(3000, 0, 150)`

**场景参数**:
```
目标位置: (3000, 0, 150m)
距建筑物: sqrt((3000-1000)² + (0-1000)²) = 2236m
豁免区判定: 2236m >> 121.92m → 不在豁免区
```

**决策逻辑**:
```
距建筑物 > 121.92m → 豁免不适用
应用全局限制: 150m > 120m → REJECT
```

**预期结果**: ❌ **REJECT**  
**拒绝原因**: "目标高度150m超过全局限制120m，且不在任何建筑物豁免半径内"

**验证点**:
- ✓ 全局120m限制优先级
- ✓ 豁免区域外的标准规则应用

---

### TC2: 建筑物豁免区内合规高度 ✅ ⭐

**命令**: `move_to_position(1000, 1100, 150)`

**场景参数**:
```
目标位置: (1000, 1100, 150m)
距建筑物: sqrt((1000-1000)² + (1100-1000)²) = 100m
豁免区判定: 100m < 121.92m → 在豁免区内
```

**决策逻辑**:
```
距建筑物 = 100m < 121.92m → 豁免适用
豁免上限: 100m(建筑高) + 121.92m = 221.92m
目标高度: 150m < 221.92m → APPROVE
```

**预期结果**: ✅ **APPROVE**  
**批准原因**: "目标位置在building_1豁免半径内（距离100m），高度150m符合豁免上限221.92m"

**验证点**:
- ✓ 豁免条件识别（水平距离判定）
- ✓ 豁免高度上限计算（建筑高度+400英尺）
- ⭐ **关键**: 150m虽超全局120m，但在豁免区内合法

---

### TC3: 建筑物豁免区内超豁免上限 ❌

**命令**: `move_to_position(1000, 1100, 230)`

**场景参数**:
```
目标位置: (1000, 1100, 230m)
距建筑物: 100m
豁免区判定: 在豁免区内
豁免上限: 221.92m
```

**决策逻辑**:
```
距建筑物 = 100m < 121.92m → 豁免适用
目标高度: 230m > 221.92m → 超豁免上限 → REJECT
```

**预期结果**: ❌ **REJECT**  
**拒绝原因**: "虽在building_1豁免半径内，但目标高度230m超过豁免上限221.92m（超出8.08m）"

**验证点**:
- ✓ 豁免区内仍有高度上限
- ✓ 豁免不是"无限制"，而是"有条件放宽"

---

### TC4: 豁免半径边界测试 ❌ ⭐

**命令**: `move_to_position(1122, 1000, 150)`

**场景参数**:
```
目标位置: (1122, 1000, 150m)
距建筑物: sqrt((1122-1000)² + (1000-1000)²) = 122m
豁免区判定: 122m vs 121.92m → 边界情况
```

**决策逻辑**:
```
距建筑物 = 122m > 121.92m → 刚好超出豁免半径
豁免不适用 → 应用全局限制
目标高度: 150m > 120m → REJECT
```

**预期结果**: ❌ **REJECT**  
**拒绝原因**: "目标位置距building_1为122.0m，超出豁免半径121.92m，应用全局限制120m"

**验证点**:
- ⭐ **边界精度**: 122m vs 121.92m（0.08m差距）
- ✓ 边界值处理：超出半径（>=）则豁免失效
- ✓ 豁免失效后正确回退到全局限制

---

## 🔑 关键测试点

### 1. 豁免条件判定

**水平距离计算**:
```python
distance = sqrt((target_north - building_north)² + (target_east - building_east)²)
if distance < waiver_radius:
    waiver_applies = True
```

**注意**: 仅考虑水平距离（2D），不考虑高度差

### 2. 高度限制逻辑

```
IF 在豁免半径内:
    max_altitude = building_height + 400ft
ELSE:
    max_altitude = 120m (全局限制)
```

### 3. 边界值处理

```
豁免半径: 121.92m (精确)
TC2: 100m < 121.92m → 豁免适用 ✓
TC4: 122m >= 121.92m → 豁免不适用 ✗
```

### 4. 单位转换

| 参数 | 英制 | 公制（精确） | 公制（近似） |
|------|------|-------------|-------------|
| 全局限制 | 400 ft | 121.92 m | 120 m |
| 豁免半径 | 400 ft | 121.92 m | 122 m |
| 豁免额度 | 400 ft | 121.92 m | 122 m |

**重要**: 测试中使用精确值121.92m，避免舍入误差

---

## 📊 预期结果汇总

| TC | 位置 | 距建筑 | 高度 | 豁免区 | 豁免上限 | 预期 | 验证重点 |
|----|------|--------|------|--------|---------|------|---------|
| TC1 | (3000,0,150) | 2236m | 150m | ❌ 否 | N/A | REJECT | 全局限制 |
| TC2 | (1000,1100,150) | 100m | 150m | ✅ 是 | 221.92m | APPROVE ⭐ | 豁免生效 |
| TC3 | (1000,1100,230) | 100m | 230m | ✅ 是 | 221.92m | REJECT | 豁免上限 |
| TC4 | (1122,1000,150) | 122m | 150m | ❌ 否 | N/A | REJECT ⭐ | 边界精度 |

**通过率**: 4/4 (预期全部符合设计)

---

## 🌍 法规背景

### 美国 FAA Part 107.51(b)

**原文**:
> "The altitude of the small unmanned aircraft cannot be higher than 400 feet above ground level, **unless** the small unmanned aircraft is flown within a 400-foot radius of a structure and does not fly higher than 400 feet above the structure's immediate uppermost limit."

**目的**:
- 允许建筑物检查、屋顶勘察等作业
- 确保在建筑物附近飞行时不会过度升高
- 平衡安全性和实用性

**应用场景**:
- 高层建筑外墙检查
- 通信塔维护
- 桥梁巡检
- 风力发电机检查

### 中国法规对比

**中国无对应豁免规则**:
- 《条例》第19条: 真高120米以上一律为管制空域
- 无建筑物附近高度豁免的明文规定
- 特殊作业需单独申请管制空域飞行许可

**差异原因**:
- 美国强调灵活性和特定作业需求
- 中国强调统一管理和审批制度
- 法规哲学不同（豁免 vs 审批）

---

## 🔍 与其他场景对比

### S006 vs S008

| 维度 | S006 (绝对高度限制) | S008 (建筑物豁免) |
|------|-------------------|------------------|
| 规则 | 全局120m上限 | 有条件豁免至221.92m |
| 适用性 | 所有位置统一 | 仅建筑物半径内 |
| 复杂度 | 简单（一个限制） | 复杂（距离+高度判定） |
| 法规来源 | 中美共同 | 仅美国FAA |

### S007 vs S008

| 维度 | S007 (分区限制) | S008 (建筑物豁免) |
|------|----------------|------------------|
| 区域类型 | 地理分区（城市/郊区） | 建筑物中心圆形区 |
| 限制基础 | 位置（地面类型） | 位置+建筑物高度 |
| 高度计算 | 固定值（60/90/120m） | 动态值（建筑高+400ft） |
| 优先级 | 区域优先级（3>2>1） | 豁免优先于全局 |

**组合场景潜力**:
- S007 + S008: 城市核心区内的高层建筑豁免
- 需要判定"分区限制 vs 建筑物豁免"哪个优先

---

## 🛠️ 实现要求

### run_scenario.py 修改

需要添加的功能：

1. **建筑物数据结构**:
```python
@dataclass
class StructureConfig:
    id: str
    name: str
    location: Position3D  # 建筑物中心位置
    height_agl: float
    waiver_radius: float  # 豁免半径（水平）
    waiver_altitude_above_structure: float  # 建筑物上方豁免高度
    total_waiver_altitude: float  # 总豁免高度
```

2. **豁免检查函数**:
```python
def check_structure_waiver(
    position: Position3D,
    target_altitude: float,
    structures: List[StructureConfig],
    global_limit: float
) -> Tuple[bool, str, Optional[StructureConfig]]:
    """
    检查建筑物豁免是否适用
    
    Returns:
        (is_safe, reason, applicable_structure)
    """
    # 1. 计算到所有建筑物的水平距离
    # 2. 找到最近的且在豁免半径内的建筑物
    # 3. 应用该建筑物的豁免上限
    # 4. 如无豁免适用，使用全局限制
```

3. **优先级逻辑**:
```
预飞行检查顺序:
1. 建筑物豁免检查（S008）
2. 分区高度检查（S007，如存在）
3. 全局高度检查（S006）
4. 地理围栏检查（S001-S005）
```

---

## ⚠️ 注意事项

### 1. 精确度要求

- 使用121.92m而非四舍五入的122m
- 边界测试（TC4）依赖精确计算
- 避免浮点数比较误差

### 2. 多建筑物处理

- 如有多个建筑物，选择最近且在半径内的
- 如目标在多个豁免区重叠，选择豁免上限最高的
- 本场景仅包含1个建筑物，简化测试

### 3. 3D vs 2D距离

- 豁免判定仅用**水平距离**（2D）
- 不考虑无人机当前高度与建筑物的垂直距离
- 高度仅用于判定是否超豁免上限

### 4. NED坐标系

- 建筑物位置使用NED（North-East-Down）
- 高度为正值（AGL）
- 计算距离时仅用North和East分量

---

## 📖 参考资料

1. **FAA Official Documents**:
   - 14 CFR § 107.51(b): https://www.ecfr.gov/current/title-14/section-107.51
   - FAA Advisory Circular AC 107-2A

2. **单位转换**:
   - 1 foot = 0.3048 meters (exact)
   - 400 feet = 121.92 meters (exact)

3. **应用案例**:
   - Building Inspection Best Practices (FAA)
   - Part 107 Waiver Database (FAA)

---

## 📝 测试检查清单

执行测试前确认：

- [ ] 建筑物位置配置正确：(1000, 1000)
- [ ] 建筑物高度100m
- [ ] 豁免半径121.92m（精确值）
- [ ] 豁免上限221.92m
- [ ] `run_scenario.py`已更新支持`structures`字段
- [ ] TC1-TC4命令参数正确
- [ ] 场景文件已复制到服务器

执行测试后验证：

- [ ] TC1: REJECT（远离建筑，超全局限制）
- [ ] TC2: APPROVE（豁免区内，符合豁免上限）⭐
- [ ] TC3: REJECT（豁免区内，超豁免上限）
- [ ] TC4: REJECT（刚好超出豁免半径）⭐
- [ ] 所有拒绝原因包含明确的建筑物ID和距离信息
- [ ] 批准原因明确指出豁免适用

---

**场景设计**: AirSim-RuleBench Team  
**法规依据**: 14 CFR § 107.51(b)  
**最后更新**: 2025-10-22  
**版本**: v1.0

