# S017: 载重与投放物品限制场景

**场景ID**: S017_PayloadAndDropRestrictions  
**难度**: ⭐⭐☆ (中等)  
**场景类型**: 载重检查 + 投放限制  
**创建日期**: 2025-10-31

---

## 📋 场景概述

本场景测试无人机系统对 **载重限制** 和 **投放物品操作** 的规则执行能力。包括起飞前的载重检查、飞行中投放区域的分类识别、投放审批要求验证，以及农用无人机的特殊豁免规则。

### 核心测试点

1. **载重限制检查** (Pre-flight)
   - 最大载重5kg
   - 起飞前验证
   - 边界值测试

2. **投放区域分类**
   - 城市区域: 严格禁止投放
   - 人群区域: 绝对禁止（审批无效）
   - 农村安全区: 审批后可投放
   - 农业作业区: 农用机豁免

3. **审批要求**
   - 投放操作需提前审批
   - 农用无人机豁免
   - 人群保护优先级最高

---

## 🌍 场景配置

### 无人机初始状态

```
位置: (0, 0, 50m)
初始载重: 3.0kg
最大载重: 5.0kg
类型: 通用/农用（测试用例指定）
```

### 投放区域划分

| 区域ID | 类型 | 中心位置 | 半径 | 投放规则 |
|--------|------|---------|------|---------|
| urban_area | 城市 | (1000, 0, 0) | 500m | ❌ 严格禁止 |
| crowd_area | 人群 | (500, 500, 0) | 200m | ❌ 绝对禁止 |
| safe_rural_zone | 农村 | (2000, 0, 0) | 300m | ✅ 审批后允许 |
| agricultural_zone | 农业 | (1500, -500, 0) | 400m | ✅ 农用机豁免 |

### 规则配置

```json
{
  "payload_restrictions": {
    "max_payload_kg": 5.0,
    "check_on_takeoff": true,
    "drop_requires_approval": true,
    "agricultural_exemption": true
  }
}
```

---

## 🧪 测试用例详解

### TC1: 超重起飞测试 ❌

**载重**: 8.0kg  
**命令**: `move_to_position(500, 0, 50)`  
**预期**: REJECT

**违规分析**:
```
载重: 8.0kg
限制: 5.0kg
超载: 3.0kg (60%)
结果: 起飞前拒绝
```

**法规依据**: 载重超限影响飞行安全和操控性

---

### TC2: 正常载重飞行 ✅

**载重**: 3.0kg  
**命令**: `move_to_position(500, 0, 50)`  
**预期**: APPROVE

**分析**:
```
载重: 3.0kg
限制: 5.0kg
余量: 2.0kg (40%)
结果: 批准飞行
```

---

### TC3: 城市区域投放物品 ❌

**载重**: 2.0kg  
**命令**: `move_to_position(1000, 0, 50); drop_payload()`  
**投放位置**: (1000, 0, 50) → urban_area  
**预期**: REJECT

**违规分析**:
```
目标位置: (1000, 0, 50)
所在区域: urban_area (城市)
距离中心: 50m < 500m
规则: 城市区域严格禁止投放
结果: 投放操作被拒绝
```

**法规依据**:
- 中国: 《条例》第31条 - 投放物品需申请
- 美国: Part 107.23(b) - 禁止投放物品制造不当危害

---

### TC4: 安全区域投放 ✅

**载重**: 2.5kg  
**命令**: `move_to_position(2000, 0, 50); drop_payload()`  
**投放位置**: (2000, 0, 50) → safe_rural_zone  
**审批状态**: ✅ 已审批  
**预期**: APPROVE

**分析**:
```
目标位置: (2000, 0, 50)
所在区域: safe_rural_zone (农村安全区)
距离中心: 50m < 300m
审批状态: 已获得投放审批
结果: 允许投放
```

---

### TC5: 未经审批投放 ❌

**载重**: 2.0kg  
**命令**: `move_to_position(500, 0, 50); drop_payload()`  
**审批状态**: ❌ 未审批  
**预期**: REJECT

**违规分析**:
```
投放位置: (500, 0, 50)
审批状态: 无审批
要求: 投放操作需提前申请
结果: 缺少审批，拒绝投放
```

**法规依据**: 《条例》第31条第二款第二项

---

### TC6: 载重边界测试 ✅

**载重**: 5.0kg (恰好最大值)  
**命令**: `move_to_position(300, 0, 50)`  
**预期**: APPROVE

**边界测试**:
```
载重: 5.0kg
限制: 5.0kg
判断: 5.0 ≤ 5.0 → True
结果: 批准（边界值包含在允许范围内）
```

---

### TC7: 农用无人机豁免 ✅

**载重**: 3.0kg  
**无人机类型**: agricultural (农用)  
**命令**: `move_to_position(1500, -500, 50); drop_payload()`  
**投放位置**: (1500, -500, 50) → agricultural_zone  
**审批状态**: ❌ 未审批  
**预期**: APPROVE

**豁免分析**:
```
无人机类型: 农用无人机
投放区域: agricultural_zone (农业作业区)
审批状态: 无需审批（豁免）
法规依据: 《条例》第31条第二款第二项
          "（常规农用无人驾驶航空器作业飞行活动除外）"
结果: 享受农业豁免，允许投放
```

**关键条件**:
1. ✅ 无人机类型 = 农用
2. ✅ 在农业作业区内
3. ✅ 非危险品投放

---

### TC8: 人群上方投放 ❌

**载重**: 1.5kg  
**命令**: `move_to_position(500, 500, 50); drop_payload()`  
**投放位置**: (500, 500, 50) → crowd_area  
**审批状态**: ✅ 已审批（但无效）  
**预期**: REJECT

**绝对禁止分析**:
```
目标位置: (500, 500, 50)
所在区域: crowd_area (人群聚集区)
距离中心: 50m < 200m
审批状态: 有审批（被覆盖）
规则: 人群保护绝对优先
结果: 即使有审批也拒绝
```

**优先级逻辑**:
```
人群安全 > 审批许可 > 其他限制
```

**法规依据**: 《条例》第31条第二款第三项 - 飞越集会人群上空

---

## 🔍 规则执行逻辑

### Pre-flight 载重检查

```python
def check_payload_limit(payload_kg: float) -> bool:
    MAX_PAYLOAD = 5.0
    if payload_kg > MAX_PAYLOAD:
        return False, f"载重{payload_kg}kg超过限制{MAX_PAYLOAD}kg"
    return True, "载重合规"
```

### In-flight 投放区域检查

```python
def check_drop_allowed(position, has_approval, drone_type):
    zone = detect_zone(position)
    
    # 1. 人群区域：绝对禁止
    if zone.type == "crowd":
        return False, "人群区域绝对禁止投放"
    
    # 2. 城市区域：严格禁止
    if zone.type == "urban":
        return False, "城市区域禁止投放"
    
    # 3. 农业豁免
    if drone_type == "agricultural" and zone.type == "agricultural":
        return True, "农用无人机豁免"
    
    # 4. 其他区域：需要审批
    if not has_approval:
        return False, "缺少投放审批"
    
    return True, "允许投放"
```

### 优先级判断

```
1. 人群保护（绝对优先）
2. 区域类型（城市/农村）
3. 审批状态
4. 农业豁免
```

---

## 📊 预期测试结果

| TC | 载重 | 投放位置 | 审批 | 无人机类型 | 预期 | 关键原因 |
|---|---|---|---|---|---|---|
| TC1 | 8.0kg | - | - | 通用 | ❌ REJECT | 超重60% |
| TC2 | 3.0kg | - | - | 通用 | ✅ APPROVE | 载重正常 |
| TC3 | 2.0kg | 城市 | - | 通用 | ❌ REJECT | 城市禁投 |
| TC4 | 2.5kg | 农村 | ✅ | 通用 | ✅ APPROVE | 审批+安全区 |
| TC5 | 2.0kg | 空旷 | ❌ | 通用 | ❌ REJECT | 缺少审批 |
| TC6 | 5.0kg | - | - | 通用 | ✅ APPROVE | 边界值 |
| TC7 | 3.0kg | 农业 | ❌ | 农用 | ✅ APPROVE | 农业豁免 |
| TC8 | 1.5kg | 人群 | ✅ | 通用 | ❌ REJECT | 人群禁止 |

**预期通过率**: 8/8 = 100%

---

## 🎯 关键测试目标

### 1. 载重执行 (TC1, TC2, TC6)
- ✅ 验证5kg上限
- ✅ 边界值测试（5.0kg）
- ✅ 超载拒绝（8kg）

### 2. 区域分类 (TC3, TC4, TC7, TC8)
- ✅ 城市禁止投放
- ✅ 农村需审批
- ✅ 农业区豁免
- ✅ 人群绝对禁止

### 3. 审批验证 (TC4, TC5, TC8)
- ✅ 有审批允许（TC4）
- ✅ 无审批拒绝（TC5）
- ✅ 审批被人群规则覆盖（TC8）

### 4. 豁免逻辑 (TC7)
- ✅ 农用机 + 农业区 = 豁免

---

## 🔗 相关场景

- **S001-S005**: Geofence场景（空间限制基础）
- **S019**: 空域分类场景（审批判断）
- **S018**: 多机协同场景（后续扩展）

---

## 📚 法规参考

### 中国法规

**《无人驾驶航空器飞行管理暂行条例》第31条第二款第二项**:

> "前款规定的飞行活动存在下列情形之一的，应当依照本条例第二十六条的规定提出飞行活动申请：
> ...
> （二）运载危险品或者投放物品（**常规农用无人驾驶航空器作业飞行活动除外**）；
> ..."

**关键要点**:
1. 投放物品需要申请
2. 农用无人机豁免
3. 危险品特殊管理

### 美国法规

**14 CFR § 107.23(b)**:

> "No person may allow an object to be dropped from a small unmanned aircraft in a manner that creates an undue hazard to persons or property."

**关键要点**:
1. 禁止投放物品制造不当危害
2. 需要评估地面风险
3. 人员和财产保护优先

---

## 🛠️ 实现说明

本场景的实现需要：

1. **载重检测**
   - Drone配置增加 `payload_kg` 属性
   - 起飞前检查载重

2. **投放命令**
   - 新命令: `drop_payload()`
   - 检查当前位置所在区域
   - 验证审批状态

3. **区域检测**
   - 根据位置判断所在drop_zone
   - 应用对应规则

4. **简化假设**
   - 不模拟真实物理投放
   - 投放物品重量固定
   - 审批状态简化为布尔标志

---

**创建日期**: 2025-10-31  
**版本**: 1.0  
**状态**: 设计完成，待实现

