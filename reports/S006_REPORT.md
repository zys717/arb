# S006 场景测试报告：绝对高度上限（120m AGL）

**测试日期**: 2025-10-22
**场景ID**: S006_AltitudeLimit
**法规依据**: 《中国无人机管理条例》第十九条，14 CFR § 107.51(b)
**测试执行**: 2025-10-22

---

## 1. 场景概述

### 1.1 测试目标

验证无人机系统能否正确识别和执行**绝对高度上限规则**（120米AGL），拒绝超过法定高度限制的飞行命令。

### 1.2 场景设计

#### 高度限制参数
- **限制高度**: 120m AGL (Above Ground Level)
- **执行模式**: 严格执行（`altitude >= 120m` → REJECT）
- **容差**: 0.0m（无容差）

#### 法规依据对比

| 维度 | 中国《条例》第十九条 | 美国Part 107.51(b) |
|------|---------------------|-------------------|
| **高度上限** | 120米真高 | 400英尺AGL (≈122m) |
| **语义** | "120米以上为管制空域" | "不得高于400英尺" |
| **本场景** | ✅ 120m及以上拒绝 | 基本一致 |

---

## 2. 测试执行详情

### TC1: 低高度飞行（50m）

**命令**: `move_to_position(100, 0, 50)`
**目标高度**: 50m AGL

#### 高度检查输出
```
🔍 Pre-flight check: Altitude limit...
   ✓ 目标高度50.0m合规（距限制70.0m）
```

#### 决策结果
- **决策**: ✅ **APPROVE**
- **理由**: 50m < 120m，远低于限制
- **轨迹**: 成功到达目标
- **轨迹点**: 228点

**结论**: ✅ **通过** - 低高度飞行正常批准

---

### TC2: 接近上限（119m）

**命令**: `move_to_position(100, 0, 119)`
**目标高度**: 119m AGL

#### 高度检查输出
```
🔍 Pre-flight check: Altitude limit...
   ✓ 目标高度119.0m合规（距限制1.0m）
```

#### 决策结果
- **决策**: ✅ **APPROVE**
- **理由**: 119m < 120m，仅差1m但仍合规
- **轨迹**: 成功到达目标
- **轨迹点**: 305点

**结论**: ✅ **通过** - 接近上限但合规的飞行正常批准

---

### TC3: 边界值（120m）⭐

**命令**: `move_to_position(100, 0, 120)`
**目标高度**: 120m AGL

#### 高度检查输出
```
🔍 Pre-flight check: Altitude limit...
   ❌ 目标高度120.0m达到或超过120.0m管制空域下限（超出0.0m）

🚫 COMMAND REJECTED (altitude limit exceeded)
```

#### 决策结果
- **决策**: 🚫 **REJECT**
- **理由**: 120m ≥ 120m，达到管制空域下限
- **轨迹**: 无人机未起飞
- **轨迹点**: 1点（仅起点）

#### 边界值分析
```
TC2 (119m):  119.0 < 120.0  → APPROVE ✅
TC3 (120m):  120.0 >= 120.0 → REJECT 🚫
差值: 1m
```

**关键验证**:
- ✅ 使用`>=`判断，而非`>`
- ✅ 120m被正确识别为"达到管制空域下限"
- ✅ 拒绝原因清晰明确

**结论**: ✅ **通过** - 这是本场景最关键的测试用例！

---

### TC4: 轻微超限（125m）

**命令**: `move_to_position(100, 0, 125)`
**目标高度**: 125m AGL

#### 高度检查输出
```
🔍 Pre-flight check: Altitude limit...
   ❌ 目标高度125.0m达到或超过120.0m管制空域下限（超出5.0m）

🚫 COMMAND REJECTED (altitude limit exceeded)
```

#### 决策结果
- **决策**: 🚫 **REJECT**
- **理由**: 125m > 120m，超出5m
- **轨迹点**: 1点（仅起点）

**结论**: ✅ **通过** - 轻微超限正确拒绝

---

### TC5: 明显超限（150m）

**命令**: `move_to_position(100, 0, 150)`
**目标高度**: 150m AGL

#### 高度检查输出
```
🔍 Pre-flight check: Altitude limit...
   ❌ 目标高度150.0m达到或超过120.0m管制空域下限（超出30.0m）

🚫 COMMAND REJECTED (altitude limit exceeded)
```

#### 决策结果
- **决策**: 🚫 **REJECT**
- **理由**: 150m >> 120m，严重超限（超出30m）
- **轨迹点**: 1点（仅起点）

**结论**: ✅ **通过** - 明显超限正确拒绝

---

### TC6: 下降到安全高度（100m）

**命令**: `move_to_position(100, 0, 100)`
**目标高度**: 100m AGL

#### 高度检查输出
```
🔍 Pre-flight check: Altitude limit...
   ✓ 目标高度100.0m合规（距限制20.0m）
```

#### 决策结果
- **决策**: ✅ **APPROVE**
- **理由**: 100m < 120m，距限制20m
- **轨迹**: 成功到达目标
- **轨迹点**: 279点

**结论**: ✅ **通过** - 下降场景正常批准

---

## 3. 核心技术验证

### 3.1 高度检查函数实现

```python
def check_altitude_limit(
    target_altitude_agl: float,
    limit: float,
    tolerance: float = 0.0
) -> Tuple[bool, str]:
    """检查目标高度是否超过法定限制"""
    effective_limit = limit + tolerance
    
    if target_altitude_agl >= effective_limit:  # 关键：使用 >=
        excess = target_altitude_agl - limit
        return (
            False,
            f"目标高度{target_altitude_agl:.1f}m达到或超过{limit:.1f}m管制空域下限（超出{excess:.1f}m）"
        )
    else:
        margin = limit - target_altitude_agl
        return (
            True,
            f"目标高度{target_altitude_agl:.1f}m合规（距限制{margin:.1f}m）"
        )
```

**验证结果**:
- ✅ 边界值判断正确：`altitude >= 120.0`
- ✅ 超出距离计算准确（0.0m / 5.0m / 30.0m）
- ✅ 拒绝原因包含"管制空域"关键词

### 3.2 NED坐标系转换

| 用户输入 | NED坐标 | AGL高度 | 检查结果 |
|---------|---------|---------|---------|
| `move_to_position(100, 0, 50)` | `down = -50.0` | `50m` | ✓ 合规 |
| `move_to_position(100, 0, 119)` | `down = -119.0` | `119m` | ✓ 合规 |
| `move_to_position(100, 0, 120)` | `down = -120.0` | `120m` | ❌ 超限 |

**转换公式验证**:
```python
target_alt = 120.0           # 用户输入
target_d = -120.0            # NED: down为负值
target_altitude_agl = -target_d  # 转换回AGL: 120m
# 检查: 120.0 >= 120.0 → REJECT ✓
```

**结论**: ✅ NED ↔ AGL转换完全正确

### 3.3 Pre-flight Check集成

**检查顺序**:
```
1. 🔍 Pre-flight check: Altitude limit...  ← 新增（S006）
2. 🔍 Pre-flight check: Target position... ← 原有（geofence）
3. 🔍 Pre-flight check: Flight path...     ← 原有（path sampling）
```

**集成位置**: 高度检查优先于geofence检查，逻辑合理

---

## 4. 测试结果总结

### 4.1 测试用例通过率

| TC  | 目标高度 | 距限制 | 预期决策 | 实际决策 | 轨迹点 | 状态 |
|-----|---------|--------|---------|---------|--------|------|
| TC1 | 50m     | -70m   | APPROVE | APPROVE | 228    | ✅   |
| TC2 | 119m    | -1m    | APPROVE | APPROVE | 305    | ✅   |
| TC3 | 120m    | 0m     | REJECT  | REJECT  | 1      | ✅ ⭐ |
| TC4 | 125m    | +5m    | REJECT  | REJECT  | 1      | ✅   |
| TC5 | 150m    | +30m   | REJECT  | REJECT  | 1      | ✅   |
| TC6 | 100m    | -20m   | APPROVE | APPROVE | 279    | ✅   |

**通过率**: **6/6 (100%)** ✅

### 4.2 关键指标

| 指标 | 值 | 备注 |
|-----|-----|------|
| 边界值判断准确率 | 100% | TC2批准，TC3拒绝 |
| 超限检测准确率 | 100% | TC4/TC5正确拒绝 |
| 拒绝原因清晰度 | 100% | 包含高度值+管制空域 |
| NED转换准确率 | 100% | 所有高度计算正确 |
| 脚本增强行数 | +50 LOC | check_altitude_limit等 |
| 轨迹数据总量 | 6,631行 | 6个测试用例 |

### 4.3 轨迹文件统计

| 文件 | 大小 | 行数 | 轨迹点 | 飞行状态 |
|-----|------|------|-------|---------|
| trajectory_S006_TC1.json | 43KB | 1841 | 228 | ✅ 成功到达 |
| trajectory_S006_TC2.json | 57KB | 2457 | 305 | ✅ 成功到达 |
| trajectory_S006_TC3.json | 824B | 28 | 1 | 🚫 拒绝 |
| trajectory_S006_TC4.json | 823B | 28 | 1 | 🚫 拒绝 |
| trajectory_S006_TC5.json | 826B | 28 | 1 | 🚫 拒绝 |
| trajectory_S006_TC6.json | 52KB | 2249 | 279 | ✅ 成功到达 |

**观察**:
- 拒绝的TC文件仅824-826B（1个轨迹点+元数据）
- 批准的TC文件43-57KB（完整飞行轨迹）
- 文件大小差异明显，便于自动化验证

---

## 5. 法规符合性分析

### 5.1 中国法规（《条例》第十九条）

**法规原文**:
```
真高120米以上空域，空中禁区、空中限制区以及周边空域，
军用航空超低空飞行空域...应当划设为管制空域
```

**符合性验证**:

| 测试 | 高度 | 法规解释 | 系统决策 | 符合性 |
|------|------|---------|---------|--------|
| TC2 | 119m | < 120m，适飞空域 | APPROVE | ✅ 符合 |
| TC3 | 120m | ≥ 120m，管制空域 | REJECT | ✅ 符合 |
| TC4 | 125m | > 120m，管制空域 | REJECT | ✅ 符合 |

**关键点**: "120米以上"的法律解释
- **包含120m本身**: 120m及以上为管制空域
- **本系统采用**: `altitude >= 120.0` → REJECT
- **法律逻辑**: ✅ 完全符合

### 5.2 美国法规（14 CFR § 107.51(b)）

**法规原文**:
```
The altitude of the small unmanned aircraft cannot be higher than 
400 feet above ground level...
```

**符合性对比**:

| 高度 | 中国《条例》 | 美国Part 107 | 系统决策 |
|------|-------------|-------------|---------|
| 119m | ✅ 适飞空域 | ✅ 390ft < 400ft | APPROVE ✅ |
| 120m | ❌ 管制空域 | ✅ 394ft < 400ft | REJECT 🚫 |
| 150m | ❌ 管制空域 | ❌ 492ft > 400ft | REJECT 🚫 |

**说明**:
- 中国120m vs 美国400ft（≈122m）基本一致
- 本场景以中国法规为准（更严格）
- 120m在美国法规下合法，但中国法规要求拒绝

### 5.3 边界值的法律语义

**中文"以上"的歧义**:
1. **数学定义**: `x > 120` (不含120)
2. **法律解释**: `x ≥ 120` (含120)

**本场景采用**: 法律解释（含120），理由：
- 安全原则：宁可保守拒绝
- 法规惯例："120米以上"通常包含边界值
- 实际操作：避免临界值飞行风险

**验证结果**: ✅ TC3正确拒绝120m

---

## 6. 技术创新与亮点

### 6.1 高度检查独立化

**设计理念**:
- **高度检查**: 全局性规则，独立维度
- **Geofence检查**: 空间性规则，3D区域
- **路径检查**: 连续性规则，轨迹采样

**优势**:
- 职责清晰，易于维护
- 可扩展（未来增加S007分区高度限制）
- 检查顺序合理（高度→位置→路径）

### 6.2 边界值工程实践

**测试设计**:
```
119m (边界-1) → 验证不误拒
120m (边界) → 验证准确拒绝
125m (边界+5) → 验证过限拒绝
```

**工程价值**:
- 经典边界值测试方法
- 暴露`>`vs`>=`的逻辑错误
- 证明系统鲁棒性

### 6.3 坐标系转换验证

**NED系统特点**:
- North: 向北为正
- East: 向东为正
- **Down**: 向下为正，向上为负 ⚠️

**转换关系**:
```python
# 用户输入（正数表示高度）
target_alt = 120.0

# NED坐标（负数表示高度）
target_down = -120.0

# AGL高度（正数）
target_altitude_agl = -target_down  # 120.0
```

**验证方法**: 所有TC的高度值与日志输出一致

---

## 7. 问题与发现

### 7.1 已解决问题

**问题1**: 场景配置schema错误
- **现象**: `'name' is a required property`
- **原因**: `actors`格式不符合ProjectAirSim要求
- **解决**: 使用正确schema（`type: robot`, `name`, `origin`, `robot-config`）

**问题2**: 缺少必需字段
- **现象**: `KeyError: 'clock'`
- **原因**: 场景配置缺少`clock`, `home-geo-point`等字段
- **解决**: 添加所有必需字段（参考S001/S005）

### 7.2 场景配置模板化

**经验教训**: 应创建标准模板避免重复错误

**必需字段清单**:
- ✅ `id`: 场景ID
- ✅ `actors`: 至少1个actor（`type`, `name`, `origin`, `robot-config`）
- ✅ `geofences`: 可为空数组
- ✅ `clock`: 时钟配置
- ✅ `home-geo-point`: 地理参考点
- ✅ `segmentation`: 分割配置
- ✅ `scene-type`: 场景类型

**建议**: 后续场景可复制S006作为模板

---

## 8. 数据对比（S001-S006）

| 场景 | 测试用例 | 主要检查 | 通过率 | 特殊能力 |
|------|---------|---------|-------|---------|
| S001 | 2 | Geofence（单一） | 100% | 基础禁飞区 |
| S002 | 4 | Geofence（多个）+3D距离 | 100% | 多geofence |
| S003 | 4 | 路径采样 | 100% | 穿越检测 |
| S004 | 4 | 多级决策（Reject/Warn/Approve） | 100% | 三级决策 |
| S005 | 5 | 时间动态TFR | 100% | **时间维度** |
| **S006** | **6** | **绝对高度上限** | **100%** | **高度维度** ⭐ |

**演进路径**:
- S001-S004: 空间维度（geofence, path, zones）
- S005: 时间维度（TFR激活/失效）
- **S006**: **高度维度（全局AGL限制）**
- 未来: S007分区高度，S008建筑物豁免

---

## 9. 结论

### 9.1 测试结论

S006场景**完全成功验证**了无人机系统的绝对高度上限检查能力：

- ✅ **边界值处理**: 119m批准，120m拒绝，精确无误
- ✅ **超限检测**: 所有超过120m的命令正确拒绝
- ✅ **拒绝原因**: 清晰提及高度值、超出距离、管制空域
- ✅ **NED转换**: 坐标系转换完全正确
- ✅ **法规符合**: 满足中国《条例》第十九条，接近美国Part 107.51
- ✅ **轨迹验证**: 拒绝TC仅1点，批准TC有完整轨迹

### 9.2 技术价值

1. **维度扩展**: 在空间（geofence）和时间（TFR）之后，引入高度维度
2. **边界值测试**: TC3（120m）是边界值工程的经典案例
3. **独立检查**: 高度检查与geofence正交，架构清晰
4. **可扩展性**: 为S007/S008奠定基础（分区高度、建筑物豁免）

### 9.3 工程质量

- **代码增强**: run_scenario.py新增50行高质量代码
- **文档完整**: README + TEST_GUIDE + REPORT三位一体
- **数据完整**: 6个轨迹文件，6,631行测试数据
- **通过率**: 100%（6/6）

### 9.4 后续工作

基于S006的成功，后续高度场景方向：

- **S007**: 分区高度限制（城市60m vs 郊区120m）
- **S008**: 建筑物附近高度豁免（美国Part 107.51例外条款）
- **S009**: 速度限制（切换到速度维度）

S006为高度限制场景系列开了个好头！🎯

---

**测试负责人**: AI Assistant
**报告日期**: 2025-10-22
**文档版本**: v1.0

---

## 附录A: 边界值分析

### 关键边界点

| 测试点 | 高度 | 判断条件 | 结果 | 正确性 |
|-------|------|---------|------|--------|
| TC2 | 119.0m | `119.0 < 120.0` | APPROVE | ✅ |
| TC3 | 120.0m | `120.0 >= 120.0` | REJECT | ✅ |
| TC4 | 125.0m | `125.0 >= 120.0` | REJECT | ✅ |

### 边界值+-1测试

```
118m: 未测试（可扩展）
119m: ✅ APPROVE  ← 边界-1
120m: 🚫 REJECT   ← 边界
121m: 未测试（可用125m代替）
```

### 浮点数精度考虑

**当前实现**: 直接比较`>=`
**潜在风险**: 浮点数精度误差（如119.99999...）
**缓解措施**: 
- 当前测试值为整数，无精度问题
- 未来可考虑容差参数（`tolerance`）

---

## 附录B: NED坐标系参考

### NED定义

- **N** (North): 向北为正，单位米
- **E** (East): 向东为正，单位米
- **D** (Down): **向下为正，向上为负**，单位米

### 高度转换表

| AGL高度 | NED Down | 转换公式 |
|---------|----------|---------|
| 0m (地面) | 0.0 | `down = -agl` |
| 50m | -50.0 | `down = -50.0` |
| 100m | -100.0 | `down = -100.0` |
| 119m | -119.0 | `down = -119.0` |
| 120m | -120.0 | `down = -120.0` |
| 150m | -150.0 | `down = -150.0` |

### 用户命令示例

```bash
# 用户输入（正数表示高度）
move_to_position(100, 0, 120)
#                 ↑   ↑   ↑
#              North East Alt

# 系统内部（NED坐标）
target_down = -120.0  # 负数！

# 高度检查（转回AGL）
target_agl = -target_down  # 120.0
check_altitude_limit(120.0, 120.0)  # REJECT
```

